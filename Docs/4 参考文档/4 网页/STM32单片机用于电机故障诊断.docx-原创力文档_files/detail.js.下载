var detail = {
    init: function(){
        var that = this;
        owa.push(['setGlobalEventProperty','aid', base.detail.aid]);
        that.reduce_re();
        that.title();
        that.intro();
        that.preview();
        that.auth();
        that.activity();
        that.userMessage();
        that.comment();
        that.recommend();
        that.downloadTips();
        that.count();
        that.interest();
        that.relate();
        that.corpus();
        that.vip();
        that.free();
        that.delfree();
        that.owa();
        that.group();
    },
    reduce_re: function(){
        detail_reduce_re.init();
    },
    title: function(){
        detail_title.init();
    },
    intro: function(){
        detail_intro.init();
    },
    preview: function(){
        detail_preview.init();
    },
    auth: function(){
        detail_auth.init();
    },
    comment: function(){
        detail_comment.init();
    },
    interest: function(){
        detail_interest.init();
    },
    relate: function(){
        detail_relate.init();
    },
    corpus: function(){
        detail_corpus.init();
    },
    owa: function(){
        detail_owa.init();
    },
    activity: function(){
        detail_activity.init();
    },
    userMessage:function(){
        userMessageFun.init();
    },
    recommend:function(){
        switch (base.detail.status.download) {
            case 1:
                //侵权电子书、可在线试读
                book_layer.init();
                break;
            default:
                break;
        };
    },
    vip: function(){
        detail_vip.init();
    },
    free: function(){
        detail_free.init();
    },
    downloadTips:function(){
        downloadTips.init();
    },
    count: function(){
        detail_count.init();
    },
    delfree: function() {
        detail_delfree.init();
    },
    group: function() {
        detail_group.init();
    }
};
var detail_reduce_re = {
    init: function(){
        var that = this;
        if( is_reduce_re_show ){
            that.layer();
        }
    },
    layer: function(){
        var that = this,
            s = util.randomNum(0,1) > 0 ? '//img.book118.com/sr1/M00/29/27/wKh2AmUw14WII9U0AABkPp9mirIAAp6tQFiCl0AAGRX616.jpg': '//img.book118.com/sr1/M00/03/19/wKh2AmUT4aSIWWh_AAANu0ftNpMAABU2gCktgkAAA3T076.png',
            c = '<div class="reduce-re" data-type="banner">'+
                    '<img width="869px" src="'+s+'" alt="1亿高质量文档大特价，1折起啦~"/>'+
                    '<i class="icon-detail">&#59078;</i>'+
                '</div>';
        $('.detail').prepend(c);
        that.bind();
    },
    bind: function(){
        $('.detail .reduce-re i').on('click',function(){
            $('.detail .reduce-re').remove();
        });
    }
};
var detail_title = {
    $title: $('.detail .title'),
    data: {
        download: base.detail.status.download
    },
    init: function(){
        var that = this;
        that.status();
        that.bind();
    },
    status: function(){
        var that = this;
        for(var k in that.data ){
            that[k]();
        }
    },
    bind: function(){
        var that = this,
            _content = '本文档属于我站3.6亿文档中的降价文档类型，降价文档约1亿，仅限一段时间降价，并非所有文档都属于降价，力争全网最低价；购买了VIP的用户，不能免费下载降价文档。',
            _index = 0;
        $('#title_download').on('click',function(){
            operate_count_step.init('downs');
        });
        $('#title_read').on('click',function(){
            operate_count_step.init('read');
        });
        $('.reduce-re,.btn-download em.tips').hover(function () {
            var _type = $(this).attr('data-type');
            _index = layer.tips(_content, this, {
                skin: 'reduce-tips',
                tips: [_type == 'bar' ? 1 : 2, '#2878ff'],
                time: 0,
                anim: -1,
                isOutAnim: false,
                maxWidth: 300
            });
        },function () {
            layer.close(_index);
        });
        owa.btn( that.$title.find('ul.operate').find('[data-owa]') );
    },
    download: function(){
        var that = this,
            $title_download = $('#title_download');
        switch(that.data.download){
            case 0:
                //免费文档
                break;
            case 1:
                //可在线试读
                that.$title.find('ul.operate').remove();
                break;
            case 2:
                //隐藏下载按钮(可付费阅读 例：川大电子书)
                if( PAY_READ_NEED == 0 ){
                    $title_download.parent().html('<a data-owa="title_read" id="title_read" href="javascript:;" class="btn btn-read" title="付费阅读全文">付费阅读全文</a>');
                }else{
                    that.$title.find('ul.operate').remove();
                }
                break
            case 3: //付费文档
            case 6: //积分文档
                //付费下载
                break;
            case 4:
                //苍穹电子书
                $title_download.parent().html('<a data-owa="title_cangqiong"  id="title_cangqiong" class="btn btn-cangqiong" href="' + base.detail.url.cangqiong + '" title="立即阅读本书" target="_blank">立即阅读本书</a>');
                break;
            case 5:
                //可知网电子书
                if( PAY_READ_NEED == 0 ){
                    $title_download.parent().html('<a data-owa="title_read" id="title_read" href="javascript:;" class="btn btn-read" title="付费阅读全文">付费阅读全文</a>');
                }else{
                    that.$title.find('ul.operate').remove();
                }
                break;
        }
    }
};
var downloadTips = {
    d:null,
    init:function(){
        var that = this;
        $(window).on('scroll',that.scroll);
    },
    scroll: function(){
        var that = downloadTips;
        clearInterval(d);
        var d = setTimeout(function(){
            if( util.isShow($('#notice .tab-items')) ){
                $(window).off('scroll',that.scroll);
                that.show();
            }
        });
    },
    show:function(){
        setTimeout(function() {
            if($('.detail .notice .tip .list').innerHeight() < 80){
                $('.detail .notice .tip').css('height','auto');
                $('.detail .notice .tip .linear, .detail .notice .tip .cover').remove();
            }else{
                $('.detail .notice .tip .cover').on('click',function(){
                    $('.detail .notice .tip').css('height','auto');
                    $('.detail .notice .tip .linear, .detail .notice .tip .cover').remove();
                });
            }
        },1000);
        
    }
};
var detail_intro = {
    init: function(){
        var that = this;
        that.bind();
    },
    bind: function(){
        var _layero = 0,
            _layeroTimer = null;
        $('#operate_report').on('click',function(){
            // operate_report.init();
            reward_report.init();
        });
        $('#operate_claim').on('click',function(){
            operate_tort.init();
        });
        $("#reward_report").hover(function() {
            var direction = 3;
            if(window.screen.width < 1366) {
                direction = 2;
            }
            _layero = layer.tips('查找并举报：包含但不限于"错误的领导人名字，职务，职级"等相关涉政内容的文档。举报成功领红包！<a class="reoprt-now" href="javascript:;">立即参与</a>', "#reward_report", {
                skin: "form-tips",
                tips: [direction, "#fff"],
                anim: -1,
                isOutAnim: false,
                time: 0,
                maxWidth: 248,
                maxHight: 177
            });
            setTimeout(function() {
                $(document).scroll(function() {
                    layer.close(_layero);
                });
                $(document).find('.reoprt-now').on('click', function() {
                    layer.close(_layero);
                    reward_report.init();
                });
            }, 300);
        }, function() {
            _layeroTimer && clearTimeout(_layeroTimer);
            _layeroTimer = setTimeout(function() {
                layer.close(_layero);
            }, 6000);
        });
        
        owa.btn( $('.intro').find('[data-owa]') );
    }
};
var detail_preview = {
    init: function() {
        var that = this;
        if( base.detail.status.blur === 0 ){
            that.blur();
        }else{
            switch(base.detail.preview.channel){
                case 'pic':
                    that.pic();
                    break;
                case 'office':
                    that.office();
                    break;
            }
            that.hd();
            that.bar();
            that.login();
        }
        that.app();
    },
    blur: function(){
        var c = '<div class="preview-blur" style="background-image:url(//img.book118.com/sr1/M00/0B/0E/wKh2AmUt_k2IBOPxAAAEc8aBpvAAAEYuAFQMXoAAASL373.png);"></div>'
        //$('.preview').html(c);
        $('.preview').html("").css({padding:0});
        setTimeout(function(){
            util.stat('init',{
                aid: base.detail.aid,
                read: base.detail.money.read,
                time: false,
                success: function(){
                    util.stat('push',{
                        login: 1,
                        next: false
                    });
                }
            });
        },1000)
    },
    pic: function(){
        util.load(__HOME_ROOT__+'/detail/js/preview.pic.js?v=20240717', function(){
            detail_preview_login.login();
        });
    },
    office: function(){
        util.load(__HOME_ROOT__+'/detail/js/preview.office.js?v=20231122', function(){
            detail_preview_login.login();
        });
    },
    hd: function(){
        detail_preview_hd.init();
    },
    bar: function(){
        detail_preview_bar.init();
    },
    login: function(){
        detail_preview_login.init();
    },
    app: function(){
        detail_preview_app.init();
    }
};
var detail_preview_limit = {
    data: {
        link: ''
    },
    getLink: function(){
        var that = this;
        $.ajax({
            url: '/user_center_v1/detail/View/limitReadGetView.html',
            method: 'GET',
            data: {
                aid: base.detail.aid
            },
            beforeSend: function(){
                util.loading();
            },
            success: function ( res ) {
                switch(res.code){
                    case 200:
                        base.member.status = 1;
                        base.member.bind_status = 1;
                        that.data.link = res.data.url;
                        that.setLink();
                        break;
                    case 1002:
                        base.member.status = 0;
                        base.member.bind_status = 0;
                        auth.init({
                            title: '登录继续免费预览',
                            callback: function(){
                                detail_preview_limit.getLink();
                            }
                        });
                        that.setLimit();
                        break;
                    case 1004:
                        //nothing
                        break;
                    case 1005:
                        base.member.status = 1;
                        base.member.bind_status = 0;
                        operate_bind.init({
                            callback: function(){
                                detail_preview_limit.getLink();
                            }
                        });
                        that.setLimit();
                        break;
                    case 2003:
                        base.detail.preview.limit.end_count = 1;
                        that.setLimit();
                        break;    
                    default:
                        util.msg(res.message);
                        break;
                }
            },
            complete: function(){
                util.loaded();
            }
        });
    },
    setLink: function(){
        var that = this;
        if( that.data.link ) {
            switch(base.detail.preview.channel){
                case 'pic':
                    preview.request(that.data.link);
                    break;
                case 'office':
                    preview.request(200,that.data.link);
                    break;
            }
        }
    },
    setLimit: function(){
        switch(base.detail.preview.channel){
            case 'pic':
                ft && ft.end();
                break;
            case 'office':
                bar && bar.clone();
                break;
        }
    }
};
var detail_preview_hd = {
    $hd: $('.preview-hd'),
    data: {
        download: base.detail.status.download
    },
    init: function(){
        var that = this;
        that.status();
        that.bind();
    },
    status: function(){
        var that = this;
        for(var k in that.data ){
            that[k]();
        }
    },
    bind: function(){
        var that = this;
        $('#hd_download').on('click',function(){
            operate_count_step.init('downs');
        });
        $('#hd_free_download').on('click',function(){
            operate_free.init();
        });
        $('#hd_read').on('click',function(){
            operate_count_step.init('read');
        });
        $('#hd_claim').on('click',function(){
            operate_tort.init();
        });
        owa.btn( that.$hd.find('ul.operate').find('[data-owa]') );
    },
    download: function(){
        var that = this,
            $hd_download = $('#hd_download');
        switch(that.data.download){
            case 0:
                //免费文档
                break;
            case 1:
                //可在线试读
                $hd_download.parent().html('<a data-owa="hd_claim" href="javascript:;" class="btn btn-claim" id="hd_claim" title="认领文档">作者认领</a>');
                break;
            case 2:
                //隐藏下载按钮(可付费阅读 例：川大电子书) 
                if( PAY_READ_NEED == 0 ){
                    $hd_download.parent().html('<a data-owa="hd_read" href="javascript:;" class="btn btn-read" id="hd_read" title="付费阅读全文">付费阅读全文</a>');
                }else{
                    $hd_download.parent().remove();
                }
                break
            case 3: //付费文档
            case 6: //积分文档
                //付费下载
                break;
            case 4:
                //苍穹电子书
                $hd_download.parent().html('<a data-owa="hd_cangqiong" id="hd_cangqiong" class="btn btn-cangqiong" href="' + base.detail.url.cangqiong + '" title="立即阅读本书" target="_blank">立即阅读本书</a>');
                break;
            case 5:
                //可知网电子书
                if( PAY_READ_NEED == 0 ){
                    $hd_download.parent().html('<a data-owa="hd_read" href="javascript:;" class="btn btn-read" id="hd_read" title="付费阅读全文">付费阅读全文</a>');
                }else{
                    $hd_download.parent().remove();
                }
                break;
        }
        if( base.detail.is_free == 1 ){
            $hd_download.parent().html('<a data-owa="hd_free" href="javascript:;" class="btn btn-free-download" id="hd_free_download" title="免费下载">免费下载</a>');
        }
    }
};
var detail_preview_bar = {
    $bar: $('.preview-bar'),
    data: {
        collect: 0,
        good: 0,
        share: base.detail.status.share,
        download: base.detail.status.download
    },
    init: function(){
        var that = this;
        that.status();
        if( base.member.status ){
            that.member();
        }else{
            auth.callbacks.push(detail_preview_bar.member);
        }
        that.bind();
    },
    status: function(){
        var that = this;
        for(var k in that.data ){
            that[k]();
        }
    },
    bind: function(){
        var that = this;
        $('#bar_collect').on('click',function(){
            that.collectPost();
        });
        $('#bar_good').on('click',function(){
            that.goodPost();
        });
        $('#bar_share').on('click',function(){
            operate_share.init();
        });
        $('#bar_download').on('click',function(){
            operate_count_step.init('downs');
        });
        $('#bar_read').on('click',function(){
            operate_count_step.init('read');
        });
        $('#bar_claim').on('click',function(){
            operate_tort.init();
        });
        owa.btn( that.$bar.find('ul.operate').find('[data-owa]') );
    },
    member: function(){
        var that = detail_preview_bar;
        $.ajax({
            url: base.detail.url.status,
            type: 'POST',
            data: { aid: base.detail.aid },
            dataType: 'JSON',
            success: function (res) {
                if( res.code == 1 ){
                    that.data.collect = +res.data.collect;
                    that.data.good = +res.data.good;
                    that.status();
                }
            }
        });
    },
    collect: function(){
        var that = this,
            $btn = $('.preview-bar ul.operate li.collect a.op');
        switch(that.data.collect){
            case 1:
                $btn.addClass('has').find('i').html('&#xe6a7;');
                break;
            case 0:
                $btn.removeClass('has').find('i').html('&#xe6a8;');
                break;
        }
    },
    collectPost: function(){
        var that = this;
        $.ajax({
            url: base.detail.url.collect,
            type: 'POST',
            data: { 
                aid: base.detail.aid ,
                type: that.data.collect ? 0 : 1
            },
            dataType: 'JSON',
            success: function (res) {
                switch( res.code) {
                    case 1:
                        util.msg(res.message);
                        that.change('collect',+res.data.status);
                        break;
                    case 4:+
                        member.login({
                            title: '操作前，请先登录',
                            callback: function(){
                                that.collectPost();
                            }
                        });
                        break;
                    default:
                        util.msg(res.message);
                        break;
                }
            },
            error: function () {
                util.msg('收藏失败！');
            }
        });
    },
    good: function(count){
        var that = this,
            $btn = $('.preview-bar ul.operate li.good a.op');
        switch(that.data.good){
            case 1:
                $btn.addClass('has').find('i').html('&#xe6a3;');
                count && $btn.find('span').text(count);
                break;
            case 0:
                $btn.removeClass('has');
                break;
        }
    },
    goodPost: function(){
        var that = this;
        $.ajax({
            url: base.detail.url.good,
            type: 'POST',
            data: { 
                aid: base.detail.aid, 
                type: 'good' 
            },
            dataType: 'JSON',
            success: function (res) {
                switch( res.code) {
                    case 1:
                        util.msg(res.message);
                        that.change('good',1,+res.data.goodpost);
                        break;
                    case 4:
                        member.login({
                            title: '操作前，请先登录',
                            callback: function(){
                                that.goodPost();
                            }
                        });
                        break;
                    default: 
                        util.msg(res.message);
                        break;
                }
            },
            error: function () {
                util.msg('点赞失败！');
            }
        });
    },
    share: function(){
        var that = this,
            $li = $('.bar ul.operate li.share');
        0 === that.data.share && $li.remove();
    },
    download: function(){
        var that = this,
            $bar_download = $('#bar_download'),
            $bar_vip_download = $('#bar_vip_download');
        switch(that.data.download){
            case 0:
                //免费文档
                break;
            case 1:
                //可在线试读
                $bar_vip_download.parent().parent().find('.vip').remove();
                $bar_download.parent().html('<a href="javascript:;" class="btn btn-claim" id="bar_claim" title="作者认领">作者认领</a>');
                break;
            case 2:
                //隐藏下载按钮(可付费阅读 例：川大电子书)
                if( PAY_READ_NEED == 0 ){
                    $bar_download.parent().html('<a href="javascript:;" class="btn btn-read" id="bar_read" title="付费阅读全文">付费阅读全文</a>');
                }else{
                    $bar_vip_download.parent().parent().find('.vip').remove();
                    $bar_download.parent().remove();
                }
                break;
            case 3:
            case 6:
                //付费下载
                break;
            case 4:
                //苍穹电子书
                $bar_vip_download.parent().parent().find('.vip').remove();
                $bar_download.parent().html('<a id="bar_cangqiong" class="btn btn-cangqiong" href="' + base.detail.url.cangqiong + '" title="立即阅读本书" target="_blank">立即阅读本书</a>');
                break;
            case 5:
                //可知网电子书
                if( PAY_READ_NEED == 0 ){
                    $bar_download.parent().html('<a href="javascript:;" class="btn btn-read" id="bar_read" title="付费阅读全文">付费阅读全文</a>');
                }else{
                    $bar_vip_download.parent().parent().find('.vip').remove();
                    $bar_download.parent().remove();
                }
                break;
        }
    },
    change: function(k,v,count){
        var that = this;
        that.data[k] = v;
        that[k](count);
    }
};
var detail_preview_login = {
    init: function(){
        if( base.detail.status.not_previewable == 4 && base.member.status != 1 ){
            auth.callbacks.push(function(){
               window.location.reload();
            });
        }
    },
    login: function(){
        var that = this;
        if( base.detail.status.not_previewable == 4 && base.member.status != 1 ){
            auth._layer = 0;
            switch( base.detail.preview.channel ){
                case 'pic':
                   that.pic();
                    break;
                case 'office':
                    that.office();
                    break;
            }
        }
    },
    pic:function(){
        var that = this,
            $ft = $('.preview-ft'),
            i = 0,
            fun = function(){
                i++;
                if( $ft.find('.read_and_download').length ){
                    $ft.find('.read_and_download').prepend('<button type="button" id="btn_preview_read" class="btn btn-read" style="width: 178px">登录继续免费预览</button>');
                    $ft.find('#btn_preview_read').on('click',function(){
                        that.layer();
                    });
                }else{
                    if( i< 100 ){
                        setTimeout(function(){
                            fun();
                        },100);
                    }
                }
            }
        fun();
    },
    office: function(){
        preview.must_login = true;
    },
    layer: function(){
        if(auth._layer > 0 && +base.member.status == 1){
            return false;
        }
        layer.open({
            id: 'layer-common-login',
            shade:0.8,
            type: 2,
            title: '继续浏览内容，请扫码登录',
            area: ['422px', '500px'],
            content:__OPEN_HOST__+'/login/login/popindex.html',
            success: function (layero, index) {
                auth._layer = index;
            }
        });
    }
};
var detail_preview_app = {
    $ft: $('.preview-ft'),
    init: function(){
        var that = this;
        switch( base.detail.status.app_ads_type ){
            case 1:
                that.pdf();
                break;
            case 2:
                that.scores();
                break;
            case 4:
                that.normal();
                break;
        }
        // that.blur();
    },
    pdf: function(){
        var that = this,
            s = '//img.book118.com/sr1/M00/39/18/wKh2AmVUO5-IaxWgAAAe2R9MxXYAAwEnAFm56oAAB7x929.png',
            c = '<div class="preview-app"><a href="'+base.detail.url.app_download+'" target="_blank" title="文档免费下载神器? 不用了，试试原创力APP!"><img src="'+s+'" alt="文档免费下载神器? 不用了，试试原创力APP!"/></a></div>';
        that.$ft.after(c);
    },
    scores: function(){
        var that = this,
            s = '//img.book118.com/sr1/M00/23/19/wKh2AmVAvhuIGlw3AAAdGWwhGxgAAN07wFfEx4AAB0x786.png',
            c = '<div class="preview-app"><a href="'+base.detail.url.app_download+'" target="_blank" title="安装原创力文档APP"><img src="'+s+'" alt="安装原创力文档APP"/></a></div>';
        that.$ft.after(c);
    },
    blur: function(){
        $('.order-receiving').remove();
        var s = '//img.book118.com/sr1/M00/10/0C/wKh2AmU2PKKIAwapAAAnI_hpeXEAAf_UgCEkYsAACc7289.png',
            c = '<div class="side-app"><a href="'+base.detail.url.app_download+'" target="_blank" title="安装原创力文档APP"><img src="'+s+'" alt="安装原创力文档APP"/></a></div>';
        $('.side').append(c);
    },
    normal: function(){
        var that = this,
            s = '//img.book118.com/sr1/M00/03/32/wKh2AmVAvk6IOCHUAAAcNeMyTNcAA0I3QCge5sAABxN682.png',
            c = '<div class="preview-app"><a href="'+base.detail.url.app_download+'" target="_blank" title="安装原创力文档APP"><img src="'+s+'" alt="安装原创力文档APP"/></a></div>';
        if( +base.detail.status.stand === 1 ) {
            s = '//img.book118.com/sr1/M00/0B/00/wKh2Amca-iqIbRBBAABK63Ot1qgAA7rPQD5f2UAAEsJ617.png';
            c = '<div class="preview-app"><a href="//www.bzchaxun.com/shareUrl.html?u=max&title='+encodeURIComponent(base.detail.search_q)+'" target="_blank" title="准行天下"><img src="'+s+'" alt="准行天下"/></a></div>';
        }
        that.$ft.after(c);
    }
};
var detail_preview_good = {
    $btn: $('#btn_preview_good'),
    $count: $('#count_preview_good'),
    data: {
        good: 0,
        count: 0
    },
    init: function(){
        var that = this;
        that.bind();
    },
    bind: function(){
        var that = this;
        that.data.count = +that.$count.find('span').text();
        that.$btn.on('click',function(){
            that.goodPost();
        });
    },
    good: function(post){
        var that = this;
        switch( that.data.good ){
            case 1:
                that.$btn.addClass('has');
                that.$btn.find('i').html('&#xe6a3;');
                if( post ){
                    that.$btn.next('strong').fadeIn('slow',function(){
                        $(this).css('display','none');
                    });
                }
                that.$count.find('span').text(that.data.count);
                break;
            case 0:
                that.$btn.find('i').html('&#xe6a4;');
                break;
        }
    },
    goodPost: function(){
        var that = this;
        $.ajax({
            url: base.detail.url.good,
            type: 'POST',
            data: { 
                aid: base.detail.aid, 
                type: 'good' 
            },
            dataType: 'JSON',
            success: function (res) {
                switch( res.code) {
                    case 1:
                        util.msg(res.message);
                        that.data.good = 1;
                        that.data.count = +res.data.goodpost;
                        that.good(1);
                        break;
                    case 4:
                        member.login({
                            title: '操作前，请先登录',
                            callback: function(){
                                that.goodPost();
                            }
                        });
                        break;
                    default: 
                        util.msg(res.message);
                        break;
                }
            },
            error: function () {
                util.msg('点赞失败！');
            }
        });
    }
};
var detail_notice = {
    $notice: $('.detail .notice'),
    data: {
        tip: ''
    },
    tip: function(){
        var that = this;
        that.$notice.find('.tip').find('.list ol').html(that.data.tip);
    }
};
var detail_interest = {
    $show: $('.detail .notice').length ? $('.detail .notice') : $('.detail .content'),
    init: function(){
        var that = this;
        $(window).on('scroll',that.scroll);
    },
    scroll: function(){
        var that = detail_interest;
        clearInterval(d);
        var d = setTimeout(function(){
            if( util.isShow(that.$show) ){
                $(window).off('scroll',that.scroll);
                if( +base.detail.status.stand === 1 ) {
                    util.load( __HOME_ROOT__ + '/detail/js/relation-stand.js?v=20210824',function(){
                        detail_stand.init();
                    },__HOME_ROOT__ + '/detail/css/relation-stand.css?v=20210824');
                }
            }
        });
    }
};
var detail_relate = {
    $relate: $('.detail .relate'),
    init: function(){
        var that = this;
        if( that.$relate.length ){
            owa.href(that.$relate.find('ul.list > li > a'), 'relate');
        }
    }
};
var detail_comment = {
    init: function(){
        var that = this;
        that.bind();
    },
    bind: function(){
        var $control = $('.comment .comment-control'),
            $btn_commit = $('.comment .btn-commit'),
            $btn_more = $('.comment .btn-more');
        $control.bind('input porpertychange, focus, blur',function(){
            operate_comment.compute();
        });
        $btn_commit.on('click',function(){
            operate_comment.commit();
        });
        $btn_more.on('click',function(){
            operate_comment.more();
        });
    }
};
var detail_auth = {
    data: {
        check_if_pay: 0,
        token: '',
        read_tips: '',
        view_must_mobile: 0,
        order_no: ''
    },
    init: function(){
        var that = this;
        auth.callbacks.push(that.callback);
    },
    callback: function(){
        var that = detail_auth;
        $.ajax({
            url: base.detail.url.auth.callback,
            type: 'GET',
            data: { 
                aid: base.detail.aid
            },
            dataType: 'JSON',
            success: function (res) {
                if( res.code == 1 ) {
                    that.data = res.data;
                    that.preview()
                    that.tip();
                }
            }
        });
    },
    preview: function(){
        var that = this;
        if( that.data.check_if_pay == 1 && that.data.token ){
            switch(base.detail.preview.channel){
                case 'pic':
                    base.detail.preview.pic.pay = PAY_READ_TAG != 1 || that.data.check_if_pay ? false : true;
                    base.detail.preview.pic.view_token = that.data.token;
                    break;
                case 'office':
                    base.detail.preview.office.pay = PAY_READ_TAG != 1 || that.data.check_if_pay ? false : true;
                    base.detail.preview.office.src = that.data.token;
                    break;
            }
            preview.change();
            $('.btn-read').remove();
        }
        preview_download.init();
    },
    tip: function(){
        var that = this;
        if( that.data.read_tips ){
            detail_notice.data.tip = that.data.read_tips;
            detail_notice.tip();
        }
    }
};
var detail_corpus = {
    data: {
        list: []
    },
    status: 'INIT', 
    init: function(){
        var that = this;
        that.getList();
    },
    getList: function(){
        var that = this;
        $.ajax({
            url: base.detail.url.corpus,
            type: 'GET',
            data: { 
                aid: base.detail.aid,
                t: base.detail.senddate
            },
            dataType: 'JSON',
            success: function (res) {
                if( res.code == 1 ) {
                    that.data.list = res.data;
                }
            },
            complete: function(){
                that.status = 'COMPLETE';
            }
        });
    }
}
var detail_owa = {
    init: function(){
        owa.push(['setGlobalEventProperty','curent_page', 'detail']);
    }
};
var detail_activity = {
    data: {
        activity: base.detail.status.activity
    },
    init: function(){
        var that = this;
        if( that.data.activity ){
            util.lazy( __HOME_ROOT__ + '/detail/js/activity.11.11.js?v=20201111',function(){
                detail_activity_11_11.init();
            }, __HOME_ROOT__ + '/detail/css/activity.11.11.css?v=20201111');
        }
    }
};
var detail_vip = {
    flag: false,
    is_check: 0,
    auto: false,
    data: {},
    is_show:true,
    init: function(){
        var that = this;
        //金币文档且VIP用户删除钜惠
        if(member.data.is_vip > 0 && base.detail.vip_type > 0){
            $('.vip-re').remove();
        }
        if(base.member.status != 1 && base.detail.vip_type > 0){
            that.setScroll();
        }
        if(base.detail.is_open_vip_down != 1) return;
        if(that.flag){
            that.member();
        }else{
            member.callbacks.push(detail_vip.member);
            that.bind();
        }
        // 5秒后刪除预览上方vip提示
        if($('.preview .vip-mark').length) {
            setTimeout(function(){
                $('.preview .vip-mark').remove();
            },5000)
        } 
    },
    member: function(){
        var that = detail_vip;
        that.flag = true;
        if(!(base.detail.vip_type > 0 && member.data.is_vip > 0) && !that.auto) {
            that.auto = true;
            autoDown.init(1);
        }
        if(base.detail.vip_type == 0) return;
        if(member.data.is_vip > 0){//是VIP用户
            that.setVipDownload();
            that.removeRecommend();
            that.setSideVipMore();
        }
        if(member.data.is_buy_vip!=1){
            that.setScroll();
        }
        that.getDocDownloadStatus();
        that.bind();
    },
    setScroll:function(){
        // var that = this;
        // $(window).scroll(function() {
        //     clearInterval(d);
        //     var d = setTimeout(function(){
        //         if( util.isShow($('#header_fixed')) && !$('.activation').length > 0){
        //             if(base.detail.show_vip == 1 && that.is_show){
        //                 that.activation();
        //             }
        //         }
        //     },300)
        // });
    },
    setSideVipMore: function(){
        var $more = $('.side .vip-doc .more');
        $more.html('<a id="btn_vipdoc_more" href="/search.html?q='+base.detail.search_q+'&doc_type=1&from=detail_side_vip" title="查看更多" target="_blank">更多 &gt;</a>');
    },
    removeRecommend: function(){
        setTimeout(function(){
            $('.webpreview-recommend').prev('.webpreview-split').remove();
            $('.webpreview-recommend').remove();
        },60)
    },
    getDocDownloadStatus: function(){
        var that = this;
        if(that.is_check) return that.setFtDownload(+that.data.status);
        $.ajax({
            url: base.detail.url.download.checkDocInfo,
            type: 'POST',
            data: {
                aid: base.detail.aid
            },
            dataType: 'JSON',
            beforeSend: function(){
                that.is_check = 1;
            },
            success: function(res){
                that.data = res.data;
                if(res.data.status == 0 && res.data.owner == 0 && (!member.data.is_vip>0 || !member.data.vip_status)) return;
                if(res.data.status == 1 || res.data.owner == 1) that.data.status = 1;
                that.setHdDownload(+res.data.status);
                that.setTitleDownload(+res.data.status);
                that.setFtDownload(+res.data.status);
                that.setBarDownload(+res.data.status);
                that.autoDownload(that.data.status);
                that.is_show=false;
            }            
        });
    },
    setVipDownload: function(){
        var $btn_vip_download = $('.btn-vip-download');
        $btn_vip_download.attr('href', 'javascript:;').removeAttr('target');
    },
    setHdDownload: function(status){
        var $hd_vip_download = $('.btn-vip-download-hd');
        switch (status) {
            case 0:
                break;
            case 1:
                base.detail.vip_type = 0;
                $hd_vip_download.replaceWith('<a data-owa="hd_download" id="hd_download" class="btn btn-download btn-download-hd" href="javascript:;" title="下载{$base.title}"><i class="icon-detail">&#xe6ae;</i> <span>下载文档</span></a>');
                $('.btn-download-hd').on('click',function(){
                    operate_count_step.init('downs');
                });
                break;
        }
    },
    setTitleDownload: function(status){
        var $title_vip_download = $('.btn-vip-download-title');
        switch (status) {
            case 0:
                break;
            case 1:
                base.detail.vip_type = 0;
                $title_vip_download.replaceWith('<a href="javascript:;" data-owa="title_download" id="title_download" class="btn btn-download btn-download-title" title="下载'+(base.detail.title)+'"><i class="icon-detail">&#xe6ae;</i> <span>下载文档</span></a>');
                $('.btn-download-title').on('click',function(){
                    operate_count_step.init('downs');
                });
                break;
        }
    },
    setFtDownload: function(status){
        var $btn_ft_vip_download = $('.preview-ft .read_and_download .btn-vip-download');
        switch (status) {
            case 0:
                $btn_ft_vip_download.attr('title','下载本文档').removeClass('btn-vip-download-ft').html('<i class="icon-detail">&#xe6ae;</i> <span>下载本文档</span>');
                break;
            case 1:
                $btn_ft_vip_download.replaceWith('<button type="button" id="btn_preview_download" class="btn btn-download" title="下载'+(base.detail.title)+'">下载文档</button>');
                $('#btn_preview_download').on('click',function(){
                    operate_count_step.init('downs');
                });
                break;
        }
    },
    setBarDownload: function(status){
        var $bar_download_li = $('#bar_download').parent(),
            $bar_vip_download_li = $('#bar_vip_download').parent();
        switch (status) {
            case 0:
                $bar_download_li.remove();
                break;
            case 1:
                $bar_vip_download_li.remove();
                if(!$('#bar_download').length){
                    $('.preview-bar .operate').prepend('<li><a data-owa="bar_download" id="bar_download" class="btn btn-download" href="javascript:;" title="下载{$base.title}"><i class="icon-detail">&#xe6ae;</i> <span>下载文档</span></a></li>')
                    $('#bar_download').off('click').on('click',function(){
                        operate_count_step.init('downs');
                    });
                }
                break;
        }
    },
    activation:function(){
        var that = this;
        var c = '<a href="javascript:;" data-owa="time_vip_download" id="time_vip_download" class="btn-vip-download btn-vip-download-title activation" title="限时开通">'+
        '<span>花2.8元获1次VIP文档下载</span>'+
        '<strong>限时开通</strong>'+
        '<i class="icon-detail">&#xe6c6;</i>'+
        '</a>';
        $('#header_fixed ul.operate li').append(c);
        $('#header_fixed ul.operate li .activation i').on('click',function(){
            $('.header ul.operate li .activation').css('display','none');
            return false;
        });
        that.bind();
    },
    autoDownload: function(status){
        if(status != 0) return;
        switch (+util.getQueryString('autodown')) {
            case 1:
                operate_count_step.init('vip',{ type: 'downs'});
                break;
        }
    },
    bind: function(){
        var that = this,
            $hd_vip_download = $('#hd_vip_download'),
            $title_vip_download = $('#title_vip_download'),
            $time_vip_download = $('#time_vip_download'),
            $bar_vip_download = $('#bar_vip_download'),
            $btn_preview_vip_download = $('#btn_preview_vip_download');
        $hd_vip_download.off('click').on('click',function(){
            that.handleInit('downs',$(this).attr('id'));
        });
        $title_vip_download.off('click').on('click',function(){
            that.handleInit('downs',$(this).attr('id'));
        });
        $time_vip_download.off('click').on('click',function(){
            that.handleInit('downs',$(this).attr('id'));
        });
        $bar_vip_download.off('click').on('click',function(){
            that.handleInit('downs',$(this).attr('id'));
        });
        $btn_preview_vip_download.off('click').on('click',function(){
            that.handleInit('read',$(this).attr('id'));
        });
    },
    handleInit: function(type,from){
        var is_company_vip = member.data.is_company_vip,
            is_vip = member.data.is_vip,
            userAgent = navigator.userAgent,
            browser_no_check = (util.getIeVersion()>0 || window.ActiveXObject || "ActiveXObject" in window) || userAgent.indexOf("Firefox") > -1 || userAgent.indexOf("Safari") > -1;
        if(browser_no_check) {
            if( is_company_vip > 0 || is_vip > 0 ){
                operate_count_step.init('vip',{ type: type,from:from });
            }else{
                window.location.href = base.member.menu.vip_open + '?from=' + from + '&interval=' + detail_count.data.interval;
            }
        }else{
            operate_count_step.init('vip',{ type: type,from:from });
        }
    }
};
var detail_free = {
    init: function(){
        var that = this;
        if( base.detail.is_free == 0 ) return;
        if( base.detail.is_free == 1 ) {
            that.setDownload();
        }
    },
    setDownload: function(){
        var that = this;
            $title_download = $('#title_download'),
            $bar_download = $('#bar_download'),
        $title_download.replaceWith('<a href="javascript:;" data-owa="title_free_download" id="title_free_download" class="btn btn-free-download" title="免费下载'+(base.detail.title)+'"><i class="icon-detail">&#xe6ae;</i> <span>免费下载</span></a>');
        $bar_download.replaceWith('<a href="javascript:;" data-owa="bar_free_download" id="bar_free_download" class="btn btn-free-download" title="免费下载'+(base.detail.title)+'"><i class="icon-detail">&#xe6ae;</i> <span>免费下载</span></a>');
        $('#title_free_download,#bar_free_download').on('click',function(){
            operate_count_step.init('free');
        });
    }
};
var detail_count = {
    data: {
        aid: base.detail.aid,
        interval: 0,
        session_id: '',
        s_id: '',
        step: '',
        port: 'pc',
        trans_type: 'downs'
    },
    session_id: '',
    init: function(){
        var that = this;
        setInterval(function(){
            that.data.interval++;
        },1000);
    },
    step: {
        init: function(trans_type,callback){
            util.load( __HOME_ROOT__ + '/detail/js/count.step.js?v=20230915',function(){
                detail_count.step.init(trans_type,callback);
            });
        },
        hit: function(){},
        arouse: function(){},
        pay: function(){},
        download: function(){}
    }
};
var side = {
    init: function(){
        var that = this;
        //that.direct();
        that.publish();
        that.similar();
        // that.vipdocs();
        // that.services();
        that.favorite();
        // that.order();
        that.fixed();
    },
    direct: function(){
        var c = '<a style="display:block;margin-bottom:10px;" href="https://www.wenjuan.com/s/UZBZJv0LaB/" target="_blank" title="调查问卷"><img src="//img.book118.com/sr1/M00/06/28/wKh2Amdg4F6IPLzQAABSU50woGgAA1QFQGBGygAAFJx123.jpg"/></a>';
        $('.side').prepend(c);
    },
    publish: function(){
        side_publish.init();
    },
    services: function(){
        side_crm_services.init();
    },
    similar: function(){
        side_similar.init();
    },
    vipdocs: function(ids){
        side_vipdocs.init(ids);
    },
    favorite: function(){
        side_favorite.init();
    },
    fixed: function(){
        side_fixed.init();
    },
    order: function() {
        side_order.init();
    }
};
var side_order = {
    init: function() {
        this.getList();
    },
    getList: function() {
        var that=this
        $.ajax({
            url: base.detail.url.getNewTask,
            data: {},
            dataType: 'JSON',
            success: function(res) {
                if(res.code !== 200 || !res.data || !res.data.length){
                    $('.side .order-receiving').remove();
                    return;
                };
                var data = res.data
                var $bd = '<div class="bd">'+
                '<h2>有需求就发悬赏 有技能就接悬赏</h2>'+
                '<dl>'+
                    '<dt>'+data[0].title+'</dt>'+
                    '<dd>'+
                        '<img src="//file-1.book118.com/sr1/M00/0C/17/wKh2AmO02GKIJE1AAAABreK5NOcAA8M3wH__jsAAAHF365.png" alt="悬赏">'+
                        '<span>'+'截至：'+data[0].deadline+'</span>'+
                        '<small>￥<em>'+data[0].price+'</em></small>'+
                    '</dd>'+
                '</dl>'+
                '<div class="order-btn">'+
                    '<a href="javascript:;" class="release-btn" title="免费发布">免费发布</a>'+
                    '<a href="javascript:;" class="receiving-btn" title="立即接单">立即接单</a>'+
                '</div>'+
            '</div>';
            $('.side .order-receiving').html($bd);
            },
            complete: function(){
                that.drainage();
            }
        })
    },
        drainage:function(){
            $('.release-btn').on('click',function(){
            util.addTaskLayer();
            })
            $('.receiving-btn').on('click',function(){
            util.getTaskLayer();
            })
        }
};
var side_publish = {
    init: function(){
        var that = this;
        that.bind();
    },
    bind: function(){
        $('#btn_publish_chat,#btn_publish_authorize_chat').on('click', function() {
            side_crm_services.statistics({
                btn:$(this),
                type:'im',
                mid: base.detail.mid
            })
            util.im({
                to_mid: base.detail.mid,//作者的mid
                to_nick: $(this).attr('data-nick'),
                request_form: 'pc_detail',
                doc: {
                    id: base.detail.aid,
                    type: base.detail.format,
                    title: base.detail.title,
                    senddate: base.detail.sendDateOriginal
                }
            })
            sm_cmd.push(['code','side_publish_success']);
        })
        $('.publish .authorize .imgs img').on('click',function(){
            layer.photos({
                photos: '#layer_pics',
                anim: 5,
                closeBtn: 1,
                shade: 0.2
            })
        })
        $('.side .publish .crm a.attend,.side .publish .intro,.side .publish .logo').hover(function(){
            window.mouseleaveAttend = false;
            operate_crm_card.init({
                el:$(this),
                type: 1,
                data: base.detail.crm.business,
                doc: {
                    id: base.detail.aid,
                    type: base.detail.format,
                    title: base.detail.title,
                    senddate: base.detail.sendDateOriginal
                }
            });
        },function(){
            window.mouseleaveAttend = true;
        })
    }
};
var side_crm_services = {
    $services: $('.side .services'),
    $type: 'serve',
    // is_business: base.detail.crm.business.mid?1:0,
    is_business: 0,
    firstType: '',//文档一级分类
    secondType: '',//文档二级分类
    is_set: true,
    flag: {
        serve_status: false,
        business_status: false
    },
    list: {
        serve: [],
        business: []
    },
    init: function(){
        var that = this;
        that.set();
        if(!base.detail.crm.load_services||!base.detail.crm.is_recommend_merchant) return;
        $('.side .services .bd').html('');
        that.$type = that.is_business==1?'serve':'business';
        that.getList();
    },
    set: function(){
        var that = this,
        typePathInfo = base.detail.typePathInfo,
        arr = [];
        for(var key in typePathInfo){
            arr.push(key);
        }
        that.firstType = typeof arr[0] != 'undefined'? arr[0]: '';
        that.secondType = typeof arr[1] != 'undefined'? arr[1]: '';
        if(!that.is_set) return;
        try {
            var crm_detail_infos= util.cookie.get('CRM_DETAIL_INFOS')?JSON.parse(util.cookie.get('CRM_DETAIL_INFOS')):[],
                new_arr = [];
            for(var i=crm_detail_infos.length-1;i>=0;i--){
                if(crm_detail_infos[i].aid==base.detail.aid) {
                    crm_detail_infos.splice(i,1);
                }
            }
            crm_detail_infos.unshift({aid:base.detail.aid,title:base.detail.title,firstType:that.firstType,secondType:that.secondType});
            for(var i=0;i<crm_detail_infos.length;i++){
                if(i<3) new_arr.push(crm_detail_infos[i]);
            }
            util.cookie.set('CRM_DETAIL_INFOS',JSON.stringify(new_arr),31220644000000);
        } catch (error) {}
    },
    getList: function(){
        var that = this,
            url = '',
            data = {},
        $tab = $('.side .services').find('.tab-items');
        if(that.flag[that.$type+'_status']) return;
        switch(that.is_business){
            case 0:
                url =that.$type=='serve'? base.detail.url.crm.services+'?from=detail': base.detail.url.crm.merchants+'?from=detail';
                data = that.$type=='serve'? {
                    firstType: that.firstType,
                    type: that.secondType,
                    keywords: base.detail.title
                }:{
                    firstType: that.firstType,
                    type: that.secondType,
                    keywords: base.detail.title,
                    merchant_mid: base.detail.mid
                }
            break;
            case 1:
                url =that.$type=='serve'? base.detail.url.crm.merchant_services+'?from=detail': base.detail.url.crm.merchants+'?from=detail';
                data = that.$type=='serve'? {
                    merchant_mid: base.detail.crm.business.mid
                }:{
                    firstType: that.firstType,
                    type: that.secondType,
                    keywords: base.detail.title,
                    merchant_mid: base.detail.crm.business.mid
                }
            break;
        }
        $.ajax({
            url: url,
            type: 'POST',
            data: data,
            dataType: 'JSON',
            beforeSend: function(){
                that.flag[that.$type+'_status'] = true;
                $tab.find('.tab-item').append('<div class="loading"></div>');
            },
            success: function (res) {
                if( res.code == 200 ) {
                    that.flag[that.$type+'_status'] = true;
                    that.list[that.$type] = res.data;
                }else{
                    that.flag[that.$type+'_status'] = false;
                }
            },
            error: function(){
                that.flag[that.$type+'_status'] = false;
            },
            complete: function(){
                that.setList();
            }
        });
    },
    setList: function(){
        var that = this,
        data = that.list[that.$type],
        $tabnav = '',
        $tabitems = '',
        $tabitem = '';
        that.$services.find('.tab-item .loading').remove();
        __ZHINENG_HOST__ = typeof __ZHINENG_HOST__ == 'undefined' || __ZHINENG_HOST__ == ''?'//zhineng.book118.com':__ZHINENG_HOST__;
        if(!$('.side .services .tab-nav').length){
            // $tabnav += '<ul class="tab-nav clear">'+
            //     (that.is_business==1?'<li><a href="javascript:;" title="'+base.detail.crm.recommend_service_title+'" data-tab-target="serve" class="active">'+base.detail.crm.recommend_service_title+'<i></i></a></li>'+
            //     '<li><a href="javascript:;" title="'+base.detail.crm.recommend_merchant_title+'" data-tab-target="business">'+base.detail.crm.recommend_merchant_title+'<i></i></a></li>':'<li><a href="javascript:;" title="'+base.detail.crm.recommend_merchant_title+'" data-tab-target="business" class="active">'+base.detail.crm.recommend_merchant_title+'<i></i></a></li>'+
            //     '<li><a href="javascript:;" title="'+base.detail.crm.recommend_service_title+'" data-tab-target="serve">'+base.detail.crm.recommend_service_title+'<i></i></a></li>')+
            // '</ul>';
            $tabnav += '<div class="hd clear">'+
                '<i></i><strong>'+base.detail.crm.recommend_merchant_title+'</strong>'+
                '<a href="'+__ZHINENG_HOST__+'/merchant.html?from=detail_more_merchant" class="btn btn-more" title="'+base.detail.crm.become_merchant_more+'" target="_blank">'+base.detail.crm.become_merchant_more+' ></a>'+
            '</div>';
            $tabitems +=  '<div class="tab-items"></div>';
            that.$services.css('display','block').find('.bd').html($tabnav+$tabitems);
        }
        switch(that.$type){
            case 'serve':
                $('.side .services .tab-item').removeClass('active');
                $tabitem +='<div class="tab-item serve active" data-tab-item="serve"><ul>';
                for(var i = 0; i < data.length; i++ ) {
                    $tabitem +='<li>'+
                        '<a href="/uhome/' + data[i].mid + '.html?from=detailservice" target="_blank" class="attend" card-type="2" data-index="'+i+'"><img src="'+data[i].img+'" alt="'+data[i].title+'" onerror="side_crm_services.imgError(this)">'+
                            '<strong>'+data[i].title+'</strong><span>';
                            for (var j = 0; j < data[i].tag.length; j++) {
                                $tabitem += '<em>' + data[i].tag[j] + '</em>';
                            }
                            $tabitem +='</span><small>已帮助'+data[i].im_num+'人</small>'+
                        '</a>'+
                    '</li>';
                }
                $tabitem +='</ul><div class="btns">'+
                '<a href="/user_center_v1/crm/home/index.html?from=detail_too_service" class="btn btn-metoo" title="'+base.detail.crm.become_service_title+'" target="_blank">'+base.detail.crm.become_service_title+'</a>'+
                '<span>|</span>'+
                '<a href="'+__ZHINENG_HOST__+'/service.html?from=detail_more_service" class="btn btn-more" title="'+base.detail.crm.become_service_more+'" target="_blank">'+base.detail.crm.become_service_more+'</a>'+
                '</div></div>';
                break;
            case 'business':
                $('.side .services .tab-item').removeClass('active');
                $tabitem +='<div class="tab-item business active" data-tab-item="business"><ul>';
                for(var i = 0; i < data.length; i++ ) {
                    $tabitem +='<li>'+
                        '<div class="logo">'+
                            '<a href="/uhome/' + data[i].mid + '.html?from=detailmerchant" target="_blank" class="attend" data-index="'+i+'">'+
                                '<img src="'+data[i].img+'" alt="头像" onerror="side_crm_services.avatarError(this)">'+
                                (data[i].auth==1?'<i class="icon-detail icon-auth-user" title="个人认证">&#xe794;</i>':'<i class="icon-detail icon-auth-company" title="机构认证">&#xe794;</i>')+
                            '</a>'+
                        '</div>'+
                        '<div class="title">'+
                            '<a href="/uhome/' + data[i].mid + '.html?from=detailmerchant" target="_blank" class="attend" data-index="'+i+'">'+
                                '<strong>'+data[i].nickname+'</strong>'+
                                '<em>'+data[i].score+'</em>'+
                                '<small>'+data[i].im_num+'人已咨询</small>'+
                            '</a>'+
                            '<a href="javascript:;" class="btn btn-to-im" mid="' + data[i].mid + '" nickName="'+data[i].nickname+'">免费咨询</a>'+
                        '</div>'+
                        '<div class="types">';
                        for (var j = 0; j < data[i].service_type.length; j++) {
                            $tabitem += '<em>' + data[i].service_type[j] + '</em>';
                        }
                        $tabitem +='</div>';
                    '</li>';
                }
                $tabitem +='</ul><div class="btns">'+
                '<a href="/user_center_v1/crm/home/index.html?from=detail_too_merchant" class="btn btn-metoo" title="'+base.detail.crm.become_merchant_title+'" target="_blank">'+base.detail.crm.become_merchant_title+' ></a>'+
                '</div></div>';
                break;
        }
        if(!that.list.serve.length&&!that.list.business.length) that.$services.remove();
        $('.side .services .tab-items').append($tabitem);
        that.bind();
    },
    bind: function(){
        var that = this;
        util.tab(that.$services);
        $('.side .services ul.tab-nav li > a').on('click', function () {
            var $type = $(this).attr('data-tab-target');
            that.$type = $type;
            that.getList();
        });
        $('.side .services a.attend').hover(function(){
            var type = $(this).attr('card-type'),
                dataIndex = $(this).attr('data-index');
            window.mouseleaveAttend = false;
            operate_crm_card.init({
                el:$(this),
                type: type?type:1,
                showType: 4,
                data: that.list[that.$type][dataIndex],
                doc: {
                    id: base.detail.aid,
                    type: base.detail.format,
                    title: base.detail.title,
                    senddate: base.detail.sendDateOriginal
                }
            });
        },function(){
            window.mouseleaveAttend = true;
        });
        $('.side .services .business .btn-to-im').on('click',function(){
            util.im({
                to_mid: $(this).attr('mid'),//作者的mid
                to_nick: $(this).attr('nickname'),
                request_form: 'pc_detail',
                doc: {
                    id: base.detail.aid,
                    type: base.detail.format,
                    title: base.detail.title,
                    senddate: base.detail.sendDateOriginal
                }
            })
            that.statistics({
                btn:$(this),
                type:'im',
                mid: $(this).attr('mid')
            })
        })
    },
    imgError: function(el){
        $(el).attr('src', __HOME_ROOT__+'/images/lazy/load.png').addClass('lazy-error');
    },
    avatarError:function(el){
        $(el).attr('src', __HOME_ROOT__+'/common/images/avator.png');
    },
    statistics: function(o){
        var $btn = o.btn;
        $.ajax({
            url: base.detail.url.crm.tongji_url,
            type: 'GET',
            data: {
                type: o.type,
                merchant_mid: o.mid,
                service_id: o.service_id
            },
            dataType: 'JSON',
            beforeSend: function(){
                $btn.attr('disabled',true).css("pointer-events","none");
            },
            complete: function(){
                $btn.attr('disabled',false).css("pointer-events","auto");
            }
        });
    }
};
var side_similar = {
    $similar: $('.side .similar'),
    ids: [],
    data: {
        list: []
    },
    timer: 0,
    init: function(){
        var that = this;
        that.getList();
    },
    getList: function(){
        var that = this;
        $.ajax({
            url: base.detail.url.similar,
            type: 'GET',
            data: { 
                aid: base.detail.aid,
                t: base.detail.senddate
            },
            dataType: 'JSONP',
            success: function (res) {
                if( res.code == 200 && res.data ) {
                    that.data.list = res.data;
                    for(var i = 0;i<res.data.length;i++){
                        that.ids.push(res.data[i].aid);
                    }
                }
            },
            complete: function(){
                that.setList();
                // side.vipdocs(that.ids.length?that.ids.join(','):'');
            }
        });
    },
    setList: function(){
        var that = this,
            data = that.data.list,
            $ul = '';
        if( data.length ){
            $ul += '<ul class="'+(base.detail.similar_style == 1?'list':'list_new')+'">';
            for( var i = 0; i < data.length; i++ ){
                if(base.detail.similar_style == 1) {
                $ul += '<li class="item">'+
                            '<a href="'+data[i].url+'" title="'+data[i].title+'" target="_blank">'+
                                '<strong><i class="icon-font icon-format icon-format-'+(data[i].filetype=='softlink'?'doc':data[i].filetype)+'"></i> <small>'+data[i].title+'</small></strong>'+
                                '<div class="bottom">'+
                                    '<div class="start">'+ that.renderScore(data[i].doc_score,5)+ '<em>'+ data[i].doc_score +'</em></div>'+
                                    '<div class="msg">'+
                                        '<small class="date">'+ data[i].date +'</small>'+
                                        '<i class="icon-font icon-common icon-common-split"></i>'+
                                        '<small class="pagenumber">'+data[i].pagenumber+'页</small>'+
                                        (data[i].vip_type>0 && base.detail.vip_type>0?'<em class="tag">VIP</em>':'')+
                                    '</div>'
                                '</div>'+
                            '</a>'+
                        '</li>';
                }else {
                    $ul += '<li class="item">' +
                    '<a class="' + (i == 0 ? 'active' : '') + '" href="' + data[i].url + '" target="_blank" title="' + data[i].title + '">' +
                        '<i class="icon icon-tag icon-tag-' + (i + 1) + '">' + (i + 1) + '</i>' +
                        '<span class="cover">' +
                            '<img class="lazy" src="' + __HOME_ROOT__ + '/images/lazy/load.png" data-src="' + data[i].litpic + '" alt="' + data[i].title + '">' +
                        '</span>' +
                        '<strong>' +(data[i].vip_type>0 && base.detail.vip_type>0?'<em>VIP</em>':'')+ data[i].title + '</strong>' +
                        '<span class="d">' +
                            '<i class="icon-font icon-hit"></i>' +
                            '<small class="num">' + data[i].click + '</small>' +
                            '<small class="line">|</small>' +
                            '<small class="num">' + data[i].pagenumber + '页</small>' +
                        '</span>' +
                    '</a>' +
                '</li>'
                }
            }
            $ul += '</ul>';
            that.$similar.css('display','block').find('.bd').html($ul);
            setTimeout(function(){
                owa.href(that.$similar.find('ul.list > li > a'), 'similar');
            },100);
            that.prependCorpus();
            that.bind();
        }else{
            that.$similar.remove()
        }
    },
    bind: function(){
        var that = this;
        util.lazyImg({
            parentSelector: '.similar ul.list_new',
            delay: 0
        });
        $('.similar ul.list_new li > a').mouseenter(function () {
            var $el = $(this);
            if (that.timer) {
                clearInterval(that.timer);
            }
            that.timer = setTimeout(function () {
                if ($el.hasClass('active')) {
                    return false;
                }
                $el.parents('ul.list_new').find('li > a').removeClass('active');
                $el.addClass('active');
                if ($el.find('img.lazy').length) {
                    util.lazyImgLoad('.similar');
                }
            }, 200);
        });
        // 兼容IE7点击封面不能跳转的BUG
        if(util.getIeVersion() == 7) {
            $('.similar ul.list_new li > a').on('click',function(){
                window.open($(this).attr('href'))
            })
        }
    },
    //星星评分
    renderScore: function(num, total) {
        var html = '<div class="score_wrap clearfix">',
            new_num = num*1000;
        for (var i = 1; i < total+1; i++) {
            var item_score = 0,
                new_i = i*1000;
            if (new_num - new_i >= 0) {
                item_score = 100;
            } else {
                item_score = (new_num - new_i + 1000)/10;
                if (item_score <= 0) {
                    item_score = 0;
                }
            }
            html += '<div class="score_item">'+
                        '<div class="img1"><i class="icon-start">&#xe84e;</i></div>'+
                        '<div class="img2" style="width:'+item_score+'%;"><i class="icon-start themeColor1">&#xe84e;</i></div>'+
                    '</div>';
        }
        html += '</div>';
        return html;
    },
    prependCorpus: function(){
        var that = this,
            c = '',
            corpus = detail_corpus,
            t = 0;
        t = setInterval(function(){
                if( corpus.status == 'COMPLETE' ){
                    clearInterval(t);
                    if( corpus.data.list.length ){
                        c = '';
                        for( var i = 0;i < 2; i++ ){
                            if( corpus.data.list[i] ){
                                c += '<li class="prepend-corpus">'+
                                        '<a href="'+corpus.data.list[i].space_url+'" title="关于《'+corpus.data.list[i].label+'》的文档合集" target="_blank">'+
                                            '<strong><i class="icon-font icon-format icon-format-corpus"></i> <small>关于《<em>'+corpus.data.list[i].label+'</em>》的文档合集</small></strong>'+
                                            '<span><small class="tag">文集</small></span>'+
                                        '</a>'+
                                    '</li>';
                            }
                        }
                        that.$similar.find('ul.list').prepend(c);
                    }
                }
            }, 300);
    }
};
var side_vipdocs = {
    $vipdocs: $('.side .vip-doc'),
    ids: '',
    data: {
        list: []
    },
    init: function(ids){
        var that = this;
        that.ids = ids;
        if(base.detail.vip_related_rule == 1 && base.detail.vip_type > 0){
            that.getList();
        }
    },
    getList: function(){
        var that = this;
        $.ajax({
            url: base.detail.url.vipdocs,
            type: 'GET',
            data: { 
                aid: base.detail.aid,
                t: base.detail.senddate,
                ids: that.ids
            },
            dataType: 'JSON',
            success: function (res) {
                if( res.code == 1 ) {
                    that.data.list = res.data;
                }
            },
            complete: function(){
                that.setList();
            }
        });
    },
    setList: function(){
        var that = this,
            data = that.data.list,
            $ul = '';
        if( data.length ){
            $ul += '<ul class="list">';
            for( var i = 0; i < data.length; i++ ){
                $ul += '<li class="item">'+
                            '<a href="'+data[i].url+'?from=detail_side_vip&index='+(i+1)+'" title="'+data[i].strip_title+'" target="_blank">'+
                                '<i class="icon-font icon-format icon-format-'+data[i].filetype+'"></i> <span>'+data[i].title+'</span><em class="mark">VIP</em>'+
                            '</a>'+
                        '</li>';
            }
            $ul += '</ul>';
            that.$vipdocs.css('display','block').find('.bd').html($ul);
            setTimeout(function(){
                owa.href(that.$vipdocs.find('ul.list > li > a'), 'vipdocs');
            },100);
            that.prependCorpus();
        }else{
            that.$vipdocs.remove()
        }
    },
    prependCorpus: function(){
        var that = this,
            c = '',
            corpus = detail_corpus,
            t = 0;
        t = setInterval(function(){
                if( corpus.status == 'COMPLETE' ){
                    clearInterval(t);
                    if( corpus.data.list.length ){
                        c = '';
                        for( var i = 0;i < 2; i++ ){
                            if( corpus.data.list[i] ){
                                c += '<li class="prepend-corpus">'+
                                        '<a href="'+corpus.data.list[i].space_url+'" title="关于《'+corpus.data.list[i].label+'》的文档合集" target="_blank">'+
                                            '<strong><i class="icon-font icon-format icon-format-corpus"></i> <small>关于《<em>'+corpus.data.list[i].label+'</em>》的文档合集</small></strong>'+
                                            '<span><small class="tag">文集</small></span>'+
                                        '</a>'+
                                    '</li>';
                            }
                        }
                        that.$similar.find('ul.list').prepend(c);
                    }
                }
            }, 300);
    }
};
var side_favorite = {
    $favorite: $('.side .favorite'),
    init: function(){
        var that = this;
        if( that.$favorite.length ){
            owa.href(that.$favorite.find('ul.list > li > a'), 'favorite');
        }
    }
};
var side_fixed = {
    $side: $('#main .side'),
    $similar: $('.side .similar'),
    $vipdoc: $('.side .vip-doc'),
    $viprecommend: $('.side .open-vip'),
    data: {
        fixed_height: 0,
        fixed_top: 0
    },
    init: function(){
        var that = this;
        util.plusEventListener(window,'scroll', that.scroll)
    },
    scroll: function(){
        var that = side_fixed;
        clearTimeout(d);
        var d = setTimeout(function () {
            var is_remove = $('#footer').offset().top - $(window).scrollTop() < that.data.fixed_height;
            if( !util.isShow(that.$side) ){
                if( $('.side-fixed').length ){
                    is_remove && $('.side-fixed').remove();
                }else{
                    that.fixed();
                }
            }else{
                $('.side-fixed').length && $('.side-fixed').remove();
            }
        }, 300);
    },
    fixed: function(){
        var that = this,
            $fixed = $('<div class="side-fixed"><div class="container"><div class="side"></div></div></div>'),
            $list_similar = null,
            $list_vipdoc = null,
            $vip_re = null;
            $other_re = null;
        if( that.$vipdoc.find('ul.list li').length ){
            that.data.fixed_height = that.$vipdoc.outerHeight();
            that.data.fixed_top = that.$vipdoc.offset().top;
            $list_vipdoc = that.$vipdoc.clone(true);
        }
        if( that.$similar.find('ul.list li').length ){
            that.data.fixed_height = $(window).height();
            $list_similar = that.$similar.clone(true);
        }
        if( that.$similar.find('ul.list_new li').length ){
            that.data.fixed_height = $(window).height();
            $list_similar = that.$similar.clone(true);
        }
        if( that.$viprecommend.length){
            that.data.fixed_height = that.$viprecommend.outerHeight();
            that.data.fixed_top = that.$viprecommend.offset().top;
            $vip_re = that.$viprecommend.clone(true);
        }
        var is_append = $('#footer').offset().top - $(window).scrollTop() > that.data.fixed_height;
        if( ($list_similar||$list_vipdoc) && is_append ){
            $fixed.find('.side').append($list_vipdoc);
            $fixed.find('.side').append($list_similar);
            $fixed.find('.side').append($vip_re);
            $('body').append($fixed);
            $fixed.fadeIn();
            setTimeout(function(){
                owa.href( $('.side-fixed .vip-doc').find('ul.list > li > a'), 'vipdoc_fixed');
            },100);
        }
    }
};
var operate_comment = {
    compute: function(){
        util.load( __HOME_ROOT__ + '/detail/js/comment.js',function(){
            operate_comment.compute();
        });
    },
    commit: function(){
        util.load( __HOME_ROOT__ + '/detail/js/comment.js',function(){
            operate_comment.commit();
        });
    },
    more: function(){
        util.load( __HOME_ROOT__ + '/detail/js/comment.js',function(){
            operate_comment.more();
        });
    }
};
var operate_count_step = {
    init: function(trans_type,options){
        detail_count.step.init(trans_type,function(){
            switch(trans_type){
                case 'free':
                    operate_free.init();
                    break;
                case 'downs':
                    operate_download.init();
                    break;
                case 'read':
                    operate_read.init();
                    break;
                case 'vip':
                    operate_download_vip.init(options.type,options.from);
            }
        });
    }
};
var operate_download = {
    init: function(){
        util.lazy( __HOME_ROOT__ + '/detail/js/download.js?v=20241225',function(){
            operate_download.init();
        });
    }
};
var operate_free = {
    init: function(){
        util.lazy( __HOME_ROOT__ + '/detail/js/free.js?v=20241225',function(){
            operate_free.init();
        },__HOME_ROOT__ + '/detail/css/free.css?v=20240205');
    }
};
var operate_vip_buy_layer = {
    init: function(options){
        util.lazy( __HOME_ROOT__ + '/detail/js/vip-buy-layer.js?v=20241225',function(){
            operate_vip_buy_layer.init(options);
        },__HOME_ROOT__ + '/detail/css/vip-buy-layer.css?v=20240205');
    }
};
var operate_download_vip = {
    init: function(type,from){
        util.load( __HOME_ROOT__ + '/detail/js/download.vip.js?v=20241217',function(){
            operate_download_vip.init(type,from);
        });
    }
};
var operate_read = {
    init: function(){
        util.lazy( __HOME_ROOT__ + '/detail/js/read.js?v=20240304',function(){
            operate_read.init();
        });
    }
};
var operate_account = {
    init: function(pay_center_data,next,type){
        util.lazy( __HOME_ROOT__ + '/detail/js/account.js?v=20230908',function(){
            operate_account.init(pay_center_data,next,type);
        },__HOME_ROOT__ + '/detail/css/account.css?v=20230811');
    }
};
var operate_wechat = {
    init: function(data,trans_type){
        util.lazy( __HOME_ROOT__ + '/detail/js/wechat.js?v=20230908',function(){
            operate_wechat.init(data,trans_type);
        },__HOME_ROOT__ + '/detail/css/wechat.css?v=20230908');
    }
};
var operate_tort = {
    init: function(){
        util.lazy( __HOME_ROOT__ + '/detail/js/tort.js?v=20230524',function(){
            operate_tort.init();
        },__HOME_ROOT__ + '/detail/css/tort.css?v=20220421');
    }
};
var operate_share = {
    init: function(){
        util.lazy( __HOME_ROOT__ + '/share/js/share.js?v=20241128',function(){
            operate_share.init();
        },__HOME_ROOT__ + '/share/css/share.css?v=20241128');
    }
};
var operate_report = {
    init: function(){
        util.lazy( __HOME_ROOT__ + '/detail/js/report.js',function(){
            operate_report.init();
        },__HOME_ROOT__ + '/detail/css/report.css');
    }
};
var book_layer ={
    init: function(){
        util.lazy( __HOME_ROOT__ + '/detail/js/bookrecommend.js?v=20240109',function(){
            recommend.init();
        },__HOME_ROOT__ + '/detail/css/bookrecommend.css?v=20211210');
    }
};
var reward_report ={
    init: function(){
        util.lazy( __HOME_ROOT__ + '/detail/js/reward.report.js?v=20220408',function(){
            reward_report.init();
        },__HOME_ROOT__ + '/detail/css/reward.report.css?v=20220408');
    }
};
var operate_crm ={
    init: function(){
        util.load( __HOME_ROOT__ + '/detail/js/crm.user.js?v=20220510',function(){
            operate_crm.init();
        },__HOME_ROOT__ + '/detail/css/crm.user.css?v=20220510');
    }
};
var operate_crm_card ={
    init: function(o){
        util.load( __UTIL_ROOT__ + '/js/crm-card.js?v=20240615',function(){
            operate_crm_card.init(o);
        },__UTIL_ROOT__ + '/css/crm-card.css?v=20240615');
    }
};
var operate_download_paper = {
    init: function(data){
        if( +base.detail.status.stand === 1 ) {
            util.lazy( __HOME_ROOT__ + '/detail/js/download.paper.js?v=20230531',function(){
                operate_download_paper.init(data);
            },__HOME_ROOT__ + '/detail/css/download.paper.css?v=20230531');
        }
    }
};
var operate_company_step = {
    init: function(trans_type,data){
        util.lazy( __HOME_ROOT__ + '/detail/js/company.step.js?v=20230531',function(){
            operate_company_step.init(trans_type,data);
        },__HOME_ROOT__ + '/detail/css/company.step.css?v=20230531');
    }
};
var operate_bind = {
    init: function(data){
        util.lazy( __HOME_ROOT__ + '/detail/js/bind.js?v=20230531',function(){
            operate_bind.init(data);
        },__HOME_ROOT__ + '/detail/css/bind.css?v=20230531');
    }
};
var preview_download = {
    data: {},
    flag: {
        qrcode: 0,
        re: 0
    },
    init: function(){
        var that = this;
        if( [3,6].indexOf(base.detail.status.download) !=-1 && base.spider == 0 ){
            if( base.detail.preview.download.qrcode ){
                switch(that.flag.qrcode){
                    case 0:
                        that.scroll();
                        util.plusEventListener(window,'scroll', that.scroll);
                        break;
                    case 1:
                        that.qrcode();
                        break;
                }
            }else{
                that.layer('btn');
            }
        }
    },
    scroll: function(){
        var that = preview_download,
            $ft = $('.preview-ft');
        if( that.flag.qrcode == 0 && $ft.length ){
            clearInterval(d);
            var d = setTimeout(function(){
                var is_show = util.isShow($ft) || Math.abs( $ft.offset().top - $(window).scrollTop() ) < 300;
                if( that.flag.qrcode == 0 && is_show ){
                    that.flag.qrcode = 1;
                    util.delEventListener(window,'scroll', that.scroll)
                    that.qrcode();
                }
            },300);
        }
    },
    qrcode: function(){
        var that = this,
            $qrcode = $('#preview_qrcode');
        $.ajax({
            url: base.detail.url.download.init,
            method: 'GET',
            data: {
                aid: base.detail.aid,
                trans_type: 'downs'
            },
            beforeSend: function(){
                if( $qrcode.length ){
                    $qrcode.find('.expire,.scanned').css('display','none');
                    $qrcode.find('.loading').css('display','block');
                }
                clearInterval(preview_qrcode.timers.turning);
                clearTimeout(preview_qrcode.timers.expire);
            },
            success: function( res ) {
                if(res.code == 100 ){
                    that.confirm();
                }else{
                    that.layer('btn');
                }
            },
            error: function(){
                that.layer('btn');
            }
        });
    },
    confirm: function(){
        var that = this;
        $.ajax({
            url: base.detail.url.download.confirm,
            method: 'GET',
            data: {
                aid: base.detail.aid,
                trans_type: 'downs'
            },
            success: function( res ) {
                switch(res.code){
                    case 201:
                        res.data.login = 0;
                        that.layer('qrcode',res.data);
                        break;
                    case 202:
                        res.data.login = 1;
                        that.layer('qrcode',res.data);
                        break;
                    default:
                        that.layer('btn');
                        break;
                }
            },
            error: function(){
                that.layer('btn');
            }
        });
    },
    layer: function(type,data) {
        var that = this,
            $btns = $('.preview .preview-ft .btns');
        switch(type){
            case 'btn':
                $('#btn_preview_download').length && $('#btn_preview_download').remove();
                $('#btn_preview_free_download').length && $('#btn_preview_free_download').remove();
                $('#btn_preview_download_activity').length && $('#btn_preview_download_activity').remove();
                $('#preview_qrcode').length && $('#preview_qrcode').remove();
                if( $btns.find('.read_and_download').length ){
                    if( base.detail.is_free == 1 ){
                        $btns.find('.read_and_download').append('<button type="button" id="btn_preview_free_download" class="btn btn-free-download">免费下载</button>');
                    }else if(base.detail.vip_type > 0 && base.detail.is_open_vip_down == 1){
                        that.getReVipDoc(function(dom){
                            $btns.find('.read_and_download').find('.re') && $btns.find('.read_and_download').find('.re').remove();
                            $btns.find('.read_and_download').append(dom);
                            that.vipDocBind();
                        })
                    } else {
                        $btns.find('.read_and_download').append('<button type="button" id="btn_preview_download" class="btn btn-download">下载文档</button>');
                    }
                }else{
                    if( base.detail.is_free == 1 ){
                        $btns.append('<div class="read_and_download"><button type="button" id="btn_preview_free_download" class="btn btn-free-download">免费下载</button></div>');
                    }else if(base.detail.vip_type > 0 && base.detail.is_open_vip_down == 1) {
                        that.getReVipDoc(function(dom){
                            $btns.append('<div class="read_and_download">'+dom+'</div>');
                            that.vipDocBind();
                        })
                    } else {
                        $btns.append('<div class="read_and_download"><button type="button" id="btn_preview_download" class="btn btn-download">下载文档</button></div>');
                    }
                }
                $('#btn_preview_free_download').on('click',function(){
                    operate_free.init();
                });
                $('#btn_preview_download').on('click',function(){
                    operate_count_step.init('downs');
                });
                if(base.detail.vip_type > 0) detail_vip.init();
                break;
            case 'qrcode':
                $('#preview_qrcode').length == 0 && $btns.append('<div id="preview_qrcode"></div>');
                preview_qrcode.init(data);
                break;
        }
    },
    getReVipDoc: function(callback) {
        var that = this,
            doFn = function() {
                if(!that.flag.re && util.isShow($('.preview-ft .btns'))) {
                    that.flag.re = 1;
                    $.ajax({
                        url: base.detail.url.moredocs,
                        data: { 
                            aid: base.detail.aid,
                            t: base.detail.senddate,
                            type: 'vip'
                        },
                        dataType: 'JSONP',
                        success: function (res) {
                            if( res.code == 200 && callback && res.data.length) {
                                callback(that.getVipDocDom(res.data));
                            }
                        }
                    });
                }
            };
        $(window).scroll(function(){
            doFn();
        })
        doFn();
    },
    getVipDocDom: function(data) {
        var isVip = member.data.is_vip > 0,
            c = '<div class="re">'+
            '<div class="re-title"><span>为您推荐更多</span><strong>'+base.detail.search_q+'</strong><span>相关文档</span></div>'+
            '<ul class="re-list">';
            for(var i=0;i<data.length;i++) {
                c+='<li>'+
                    '<a href="'+(isVip?data[i].url:'/user_center_v1/home/vip/open?aid='+data[i].aid)+'" title="'+data[i].title+'" target="_blank">'+
                        '<span class="cover">'+
                            '<img class="lazy" src="' + __HOME_ROOT__ + '/images/lazy/load.png" data-src="' + data[i].litpic + '" alt="' + data[i].title + '">' +
                            '<i>VIP</i>'+
                        '</span>'+
                        '<strong>'+data[i].title+'</strong>'+
                        '<label>'+
                            '<span><i class="icon-detail">&#xe6d2;</i>'+data[i].click+'</span>'+
                            '<span class="line">|</span>'+
                            '<span>' + data[i].pagenumber +'页</span>'+
                        '</label>'+
                    '</a>'+
                '</li>';
            }
            c+='</ul>'+
            (isVip>0?'':'<div class="re-btn">'+
            '<a href="/user_center_v1/home/vip/open" title="最低5.8元开通VIP，1.5亿+文档免费下载" class="btn btn-detail-ft-vip" target="_blank">最低5.8元开通VIP，1.5亿+文档免费下载<em>98%用户选择</em></a>'+
            '</div>')+
        '</div>';
        return c;
    },
    vipDocBind: function(){
        util.lazyImg({
            parentSelector: '.read_and_download .re ul.re-list',
            delay: 0
        });
        // 兼容IE7点击封面不能跳转的BUG
        if(util.getIeVersion() == 7) {
            $('.read_and_download .re ul.re-list li>a').on('click',function(){
                window.open($(this).attr('href'))
            })
        }
    }
};
var preview_qrcode = {
    timers: {
        turning: 0,
        expire: 0
    },
    init: function(data){
        util.load( __HOME_ROOT__ + '/detail/js/preview.qrcode.js?v=20240313',function(){
            preview_qrcode.init(data);
        },__HOME_ROOT__ + '/detail/css/preview.qrcode.css');
    }
};
var hit = {
    name: 'a_'+ base.detail.aid,
    init: function(){
        var that = this;
        switch(base.spider){
            case 0:
                that.request();
                break;
            case 1:
                break;
        }
    },
    request: function(){
        var that = this;
        if (!util.cookie.get(that.name) ) {
            $.get(base.detail.url.hit + '&aid='+base.detail.aid);
            owa.load(['trackAction','doc_click', 'pc']);
        }
    }
};
//url参数是否有form=activity 是就立即执行下载；
var integral = {
    download: [3,6].indexOf(base.detail.status.download) != -1, //是否支持下载
    init: function(){
        var that = this;
        if( that.download && util.getQueryString('from') === 'activity' ){
            operate_count_step.init('downs');
        }
    }
};
var autoDown = {
    init: function(status){
        var auto = util.getQueryString('autodown') == 2;
        if(auto && (base.member.status == 0 || status == 1)) {
            operate_count_step.init('downs');
        }
    }
};
// 商户联系用户
var detailcrm = {
    timer: 0,
    flag: true,
    init: function(){
        var that = this;
        that.bind();
    },
    bind: function(){
        var that = this;
        if(util.getIeVersion()>0&&util.getIeVersion()<=9) return false;
        that.crmInit();
        that.pageVisibilityChange();
    },
    pageVisibilityChange: function () {
        var that = this,
            hiddenProperty = 'hidden' in document ? 'hidden' : 'webkitHidden' in document ? 'webkitHidden' : 'mozHidden' in document ? 'mozHidden' : null,
            visibilityChangeEvent = hiddenProperty.replace(/hidden/i, 'visibilitychange'),
            onVisibilityChange = function () {
                if (!document[hiddenProperty]) {
                    if(that.flag) that.crmInit();
                } else {
                    that.timer && clearInterval(that.timer);
                }
            };
        document.addEventListener(visibilityChangeEvent, onVisibilityChange);
    },
    crmInit: function(){
        var that = this;
        if(((base.detail.crm.is_open_crm)||(!base.detail.crm.is_open_crm&&util.cookie.get('ALLOW_CON_WEBSOKET')==1))&&util.cookie.get('FORBID_SAY_HELLO_LAYER')!=1)
        that.timer = setTimeout(function(){
            that.flag = false;
            operate_crm.init();
        },1000*base.detail.crm.begin_time)
    }
};
//商户头像hover信息弹窗
var userMessageFun = {
    _time:0,
    __time:0,
    init:function(){
        var that = this;
        that.messageLayer();
        that.regard();
    },
    messageLayer:function(){
        var that = this;
        $('.publish .info .authen-type,.publish .stand .info img,.field-tips i,.field-tips span').hover(function(){
            clearTimeout(that.__time);
            $(".publish .user-message").css('display','block');
        },function(){
            if(that._time){
                clearTimeout(that._time);
            }
            that._time = setTimeout(function(){
                $(".publish .user-message").css('display','none');
            },100);
        });
        $(".publish .user-message").mouseenter(function(){
            clearTimeout(that._time);
        });
        $(".publish .user-message").mouseleave(function () { 
            $(".publish .user-message").css('display','none');
            if(that.__time){
                clearTimeout(that.__time);
            }
            that.__time =setTimeout(function(){
                $(".publish .user-message").css('display','none');
            },100)
        });
    },
    regard:function(){
        var that = this;
        $('#regard').on('click',function(){
            var _class = $(this).attr('class'),
                _mid = $(this).attr('data-mid');
            if(_class == 'no-regard'){
                that.regardRequest(_mid,$(this),1)
            }else{
                that.regardRequest(_mid,$(this),0)
            }
        });
    },
    regardRequest:function(mid,$this,type){
        $.ajax({
            type: "POST",
            url: base.detail.url.regard,
            data: {userid:mid,type:type},
            dataType: "JSON",
            beforeSend:function(){
                $this.attr('disabled',true);
            },
            success: function (res) {
                switch (res.code) {
                    case 0:
                        layer.msg(res.message)
                        break;
                    case 1:
                        if(type == 0){
                            $this.removeClass('regard').addClass('no-regard').text('+ 关注').attr('title','点击关注');
                        }else{
                            $this.removeClass('no-regard').addClass('regard').text('已关注').attr('title','取消关注');
                        }
                        layer.msg(res.message)
                        break;
                    case 4:
                        member.login({
                            title: '操作前，请先登录',
                            callback: function(){}
                        });
                        break;
                    default:
                        break;
                }
            },
            complete:function(){
                $this.attr('disabled',false);
            }
        });
    }
};
var extend = {
    keyArr:[],
    init:function(){
        var that = this;
        that.extendRequest();
    },
    extendRequest:function(){
        var that = this;
        $.ajax({
            type: "POST",
            url: base.more.url.commonBrowseNew,
            data: {aids:base.detail.aid,t:base.detail.sendDateOriginal},
            dataType: 'JSON',
            success: function (res) {
                if(res.code == 200){
                    //IE7不支持Object.keys(),只能遍历获取key去判断对象长度了
                    for (var key in res.data){
                        that.keyArr.push(key)
                    }
                    if(that.keyArr.length){
                        that.extendDom(res.data)
                    }
                }
          
            }
        });
    },
    extendDom:function(docData){
        var that = this,
            d = '';
        for (var i = 0;i < docData.length; i++) {
            var q = '';
            for (var k = 0 ;k < docData[i].doc_infos.length; k++) {
                q+= '<a href="'+ docData[i].doc_infos[k].arc +'" title="'+ util.htmlEscape(docData[i].doc_infos[k].title) +'" target="_blank">'+
                        '<div class="title">'+
                            '<i class="icon-font icon-tag '+ that.sortTag(k) +'">'+ (parseInt(k)+1) +'</i>'+
                            '<span>'+ util.htmlEscape(docData[i].doc_infos[k].title) +'</span>'+
                        '</div>'+
                        '<div class="label">'+
                            '<span class="date">'+
                                '<i class="icon-detail">&#xe6d2;</i> <em>'+ docData[i].doc_infos[k].hits +'</em><i class="icon-font icon-common icon-common-split"></i><em>'+ docData[i].doc_infos[k].pagenumber +'页</em>'+
                            '</span>'+
                        '</div>'+
                    '</a>';
            }
            d += '<li>'+
                    '<div class="user">'+
                        // '<span><em>'+ util.htmlEscape(docData[i].mid_infos.uname) +'</em> 最近在看</span>'+
                        '<span>扩展阅读'+ (parseInt(i)+1) +'</span>'+
                        '<i class="icon '+ (i == 0 ? 'icon-close':'icon-show') +'"></i> '+
                    '</div>'+
                    '<div class="content'+ (i == 0 ? '' :' hidden') +'">'+ q +'</div>'+
                '</li>';
        }
        var c = '<div class="extend">'+
                    '<div class="hd"><h3>扩展阅读</h3></div>'+
                    '<div class="bd"><ul class="list">'+ d +'</ul></div>'+
                '</div>';
        $('.favorite').after(c);
        var $user = $(document).find('.extend .user');
        $user.on('click',function(){
            var isHas = $(this).children('i').hasClass('icon-show');
            if(isHas){
                $user.children('i').removeClass('icon-close').addClass('icon-show');
                $user.next().addClass('hidden');
                $(this).children('i').removeClass('icon-show').addClass('icon-close');
                $(this).next().removeClass('hidden');
            }else{
                $(this).children('i').removeClass('icon-close').addClass('icon-show');
                $(this).next().addClass('hidden');
            }            
        });
    },
    sortTag:function(i){
        var q='';
        switch (i) {
        case 0:
            q = 'icon-tag-1'
            break;
        case 1:
            q = 'icon-tag-2'
            break;
        case 2:
            q = 'icon-tag-3'
            break;
        default:
            q = 'icon-tag-other'
            break;
        }
        return q;
    }
};
var expand = {
    isStatistics:true,
    indexArr:[],
    idArr:[],
    isShow:true,
    init:function(){
        var that = this;
        $(window).on('scroll',that.scroll);
    },
    scroll: function(){
        var that = expand;
        clearInterval(d);
        var d = setTimeout(function(){
            if( util.isShow($('#expand')) && that.isShow){
                $(window).off('scroll',that.scroll);
                that.isShow = false;
                that.request();
            }
        });
    },
    request:function(){
        var that = this;
        $.ajax({
            type: "POST",
            url: base.more.url.collectData,
            data: {aid:base.detail.aid,t:base.detail.senddate},
            dataType: 'JSON',
            success: function (res) {
                if(res.code == 1){
                    if(res.data.length){
                        that.montageDom(res.data);
                        //请求成功后埋点
                        sm_cmd.push(['code','expand_show']);
                        // sm_cmd.push(['define',{expand_show: 1}]);
                    }
                }
            }
        });
    },
    montageDom:function(data){
        var that = this,
            p = '';
        for (var i = 0; i < data.length; i++) {
            var d = '',
                x = data[i].data.length > 5 ? 5 : data[i].data.length;
            for (var k = 0; k < x; k++) {
                d += '<li>'+
                        '<i class="icon-num '+ that.sortTag(parseInt(k)+1) +'">'+ (parseInt(k)+1) +'</i>'+
                        '<strong><a data-id="'+ data[i].id +'" data-index="'+ (i+'-'+k) +'" href="'+ data[i].data[k].url +'" title="'+ data[i].data[k].title +'" target="_blank">'+ data[i].data[k].title +'</a></strong>'+
                    '</li>';
            }
            p += '<div class="item" data-id="'+ data[i].id +'">'+
                    '<div class="expand-content">'+
                        // '<div class="expand-title">'+
                        //     '<span class="folder-title"><i class="icon-font icon-folder"></i> <strong>'+ data[i].title +'</strong></span>'+
                        //     '<span class="data">创建时间：'+ data[i].create_time +' | '+ data[i].doc_count +'个文档</span>'+
                        // '</div>'+
                        '<ul class="list">'+ d +'</ul>'+
                        '<dl class="more-app">'+
                            '<dt><a href="/app.html" target="_blank" class="btn" title="APP内查看其余文档">APP内查看其余文档（共'+data[i].doc_count+'个文档）</a></dt>'+
                            '<dd>安装后，请搜索文集名称<span>“'+ data[i].title +'”</span></dd>'+
                        '</dl>'+
                        '<div class="toggle-show"><i class="icon icon-show"></i></div>'+
                    '</div>'+
                '</div>';
        }
        var q = '<div class="expand">'+
                    '<div class="hd">'+
                        '<h3>拓展阅读</h3>'+
                    '</div>'+
                    '<div class="expand-bd expand-clear">'+ p +'</div>'+
                '</div>';
        $('#expand').append(q);
        that.expandHover();
    },
    sortTag:function(i){
        var q='';
        switch (i) {
        case 0:
            q = 'icon-num-1'
            break;
        case 1:
            q = 'icon-num-2'
            break;
        case 2:
            q = 'icon-num-3'
            break;
        default:
            break;
        }
        return q;
    },
    expandHover:function(){
        var that = this,
            $item = $('.detail .expand .expand-bd .item');
        var userAgent = navigator.userAgent;  //IE11 高度兼容
        var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;//IE11 高度兼容
        if(util.getIeVersion()==0 && isIE11){//IE11 高度兼容
            $item.find('ul').css('height','200px');
        }
        $item.on('mouseenter',function(){
            var _windowH = $(window).height();//窗口可视区域高度
            var _bottom = $(this)[0].getBoundingClientRect().bottom;// 元素下边距离页面上边的距离
            var _children = $(this).children('.expand-content');
            if(_windowH - _bottom < 200){
                _children.addClass('expand-content-bottom')
            }else{
                _children.addClass('expand-content-top')
            }
            $(this).css('z-index',99);//IE7 兼容
            if(util.getIeVersion()==0 && isIE11){//IE11 高度兼容
                $(this).find('ul.list').css('height','auto');
            }
            $(this).find('.more-app').css('display','block');
            $(this).find('.toggle-show').css('display','none');
            that.expandHoverStatistics($(this).attr('data-id'),$(this).index());
        });
        $item.on('mouseleave',function(){
            var _children = $(this).children('.expand-content');
            // setTimeout(function() {
                _children.removeClass('expand-content-top')
                _children.removeClass('expand-content-bottom')
            // }, 200);
            $(this).css('z-index',1);//IE7 兼容
            if(util.getIeVersion()==0 && isIE11){//IE11 高度兼容
                $(this).find('ul.list').css('height','200px');
            }
            $(this).find('.toggle-show').css('display','block');
            $(this).find('.more-app').css('display','none');
        });
        $item.find('li a').on('click',function(){
            that.expandClickStatistics($(this).attr('data-id'),$(this).attr('data-index'));
        });
    },
    //hover 埋点统计
    expandHoverStatistics:function(id,index){
        var that = this;
        if(that.idArr.indexOf(id) == -1){
            that.idArr.push(id);
            // sm_cmd.push(['define',{expand_show: 0,expand_hover: index}]);
            sm_cmd.push(['code','expand_hover']);
        }
    },
    //click 埋点统计
    expandClickStatistics:function(id,index){
        var that = this;
        if(that.indexArr.indexOf(index) == -1 && that.isStatistics){
            $.ajax({
                type: "POST",
                url: base.more.url.clickCollect,
                data: {id:id},
                dataType: "JSON",
                beforeSend:function(){
                    that.isStatistics = false;
                },
                success:function(res){
                    if(res.code == 1){
                        that.indexArr.push(index);
                    }
                },
                complete:function(){
                    that.isStatistics = true;
                }
            });
        }
    }
}
// 移除免费文档
var detail_delfree = {
    init: function() {
		var refer = document.referrer;
        if (refer.indexOf('baidu.com') > -1 
            || refer.indexOf('so.com') > -1 
            || refer.indexOf('bing.com') > -1 
            || refer.indexOf('sogou.com') > -1
            || refer.indexOf('toutiao.com') > -1
            || refer.indexOf('sm.cn') > -1) {
            this.delFree();
		}
    },
    delFree: function() {
        $.ajax({
            url: base.detail.url.del_free,
            data: { aid: base.detail.aid }
        });
    }
}
// 加群
var detail_group = {
    data: null,
    init: function() {
        var that = this;
        $(window).on('scroll',that.scroll);
        that.scroll();
    },
    scroll: function(){
        var that = detail_group;
        clearInterval(d);
        var d = setTimeout(function(){
            if( util.isShow($('.detail .group')) ){
                $(window).off('scroll',that.scroll);
                that.show();
                clearInterval(d);
            }
        });
    },
    show: function(){
        var that = this;
        $.ajax({
            url: base.detail.url.getwechatgroup,
            data: { aid: base.detail.aid },
            dataType: 'JSONP',
            success: function(res) {
                if (res.status == 200) {
                    that.data = res.data;
                    that.setGroup();
                }
            },
            complete: function() {
                if(!that.data) {
                    $('.detail .group').remove();
                }
            }
        });
    },
    setGroup: function() {
        var that = this,
            c = '<ul>'+
            '<li class="avatar">'+
                '<img src="'+that.data.img+'" alt="群头像">'+
                '<span>加入：'+that.data.name+'</span>'+
            '</li>'+
            '<li class="arrow">'+
                '<small>微信扫码加入</small>'+
                '<i class="icon-font"></i>'+
            '</li>'+
            '<li class="qrcode">'+
                '<img src="'+that.data.wechat.ticket+'" alt="二维码">'+
            '</li>'+
        '</ul>';
        $('.detail .group').html(c);
    }
}
$(function(){
    detail.init();
    side.init();
    hit.init();
    integral.init();
    detailcrm.init();
    autoDown.init(1);
    // extend.init();//扩展阅读
    expand.init();//文集
    // operate_download_paper.init()
});